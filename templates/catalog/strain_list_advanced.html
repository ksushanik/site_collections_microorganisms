{% extends "base.html" %}

{% block title %}–®—Ç–∞–º–º—ã - –°–ò–§–ò–ë–† –°–û –†–ê–ù{% endblock %}

{% block extra_css %}
<style>
/* –ë–∞–π–∫–∞–ª—å—Å–∫–∞—è —Ç–µ–º–∞—Ç–∏–∫–∞ - —Å–∏–Ω–∏–µ —Ç–æ–Ω–∞ */
:root {
    --baikal-primary: #1565C0;
    --baikal-secondary: #0D47A1;
    --baikal-light: #E3F2FD;
    --baikal-accent: #42A5F5;
}

.baikal-header {
    background: linear-gradient(135deg, var(--baikal-primary), var(--baikal-secondary));
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.strain-card {
    transition: all 0.3s ease;
    border-left: 4px solid var(--baikal-accent);
}

.strain-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(21, 101, 192, 0.2);
}

.extremophile-badge {
    background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
    color: white;
    border: none;
}

.filter-section {
    background: var(--baikal-light);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.data-table {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.table-header {
    background: var(--baikal-primary);
    color: white;
}

.organism-icon {
    display: inline-block;
    width: 24px;
    height: 24px;
    background: var(--baikal-accent);
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    color: white;
    font-size: 12px;
    margin-right: 8px;
}

.coordinates-link {
    color: var(--baikal-primary);
    text-decoration: none;
    font-size: 0.9em;
}

.coordinates-link:hover {
    text-decoration: underline;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –¥–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ */
.characteristic-bar {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    position: relative;
    margin: 5px 0;
}

.characteristic-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.temp-fill { 
    background: linear-gradient(90deg, #74b9ff, #0984e3); 
}

.ph-fill { 
    background: linear-gradient(90deg, #fd79a8, #e84393); 
}

.genome-fill { 
    background: linear-gradient(90deg, #55a3ff, #3742fa); 
}
</style>
{% endblock %}

{% block content %}
<div class="baikal-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-bacteria fs-1"></i>
                    –®—Ç–∞–º–º—ã –º–∏–∫—Ä–æ–æ—Ä–≥–∞–Ω–∏–∑–º–æ–≤ –æ–∑–µ—Ä–∞ –ë–∞–π–∫–∞–ª
                </h1>
                <p class="lead mb-0">
                    –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è —ç–∫—Å—Ç—Ä–µ–º–æ—Ñ–∏–ª—å–Ω—ã—Ö –º–∏–∫—Ä–æ–æ—Ä–≥–∞–Ω–∏–∑–º–æ–≤ –ë–∞–π–∫–∞–ª—å—Å–∫–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex flex-column align-items-end">
                    <span class="badge bg-light text-dark fs-6 mb-1">
                        <i class="bi bi-database"></i> {{ strains.count }} —à—Ç–∞–º–º–æ–≤
                    </span>
                    <span class="badge bg-light text-dark fs-6">
                        <i class="bi bi-collection"></i> {{ collections_count }} –∫–æ–ª–ª–µ–∫—Ü–∏–π
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
    <div class="filter-section">
        <form method="get" id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">
                    <i class="bi bi-search"></i> –ü–æ–∏—Å–∫
                </label>
                <input type="text" class="form-control" name="search" 
                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, —Ä–æ–¥, –∏—Å—Ç–æ—á–Ω–∏–∫..." 
                       value="{{ request.GET.search }}">
            </div>
            
            <div class="col-md-2">
                <label class="form-label">
                    <i class="bi bi-collection"></i> –ö–æ–ª–ª–µ–∫—Ü–∏—è
                </label>
                <select class="form-select" name="collection">
                    <option value="">–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</option>
                    {% for collection in collections %}
                    <option value="{{ collection.id }}" 
                            {% if request.GET.collection == collection.id|stringformat:"s" %}selected{% endif %}>
                        {{ collection.code }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label">
                    <i class="bi bi-geo-alt"></i> –°—Ä–µ–¥–∞ –æ–±–∏—Ç–∞–Ω–∏—è
                </label>
                <select class="form-select" name="habitat_type">
                    <option value="">–í—Å–µ —Å—Ä–µ–¥—ã</option>
                    <option value="baikal_surface" {% if request.GET.habitat_type == "baikal_surface" %}selected{% endif %}>
                        üåä –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –ë–∞–π–∫–∞–ª–∞
                    </option>
                    <option value="baikal_deep" {% if request.GET.habitat_type == "baikal_deep" %}selected{% endif %}>
                        üèîÔ∏è –ì–ª—É–±–∏–Ω—ã –ë–∞–π–∫–∞–ª–∞
                    </option>
                    <option value="baikal_bottom" {% if request.GET.habitat_type == "baikal_bottom" %}selected{% endif %}>
                        ‚¨áÔ∏è –î–Ω–æ –ë–∞–π–∫–∞–ª–∞
                    </option>
                    <option value="soil" {% if request.GET.habitat_type == "soil" %}selected{% endif %}>
                        üå± –ü–æ—á–≤–∞ –ü—Ä–∏–±–∞–π–∫–∞–ª—å—è
                    </option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label">
                    <i class="bi bi-thermometer"></i> –≠–∫—Å—Ç—Ä–µ–º–æ—Ñ–∏–ª—ã
                </label>
                <select class="form-select" name="extremophiles">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="psychrophiles" {% if request.GET.extremophiles == "psychrophiles" %}selected{% endif %}>
                        ‚ùÑÔ∏è –ü—Å–∏—Ö—Ä–æ—Ñ–∏–ª—ã
                    </option>
                    <option value="thermophiles" {% if request.GET.extremophiles == "thermophiles" %}selected{% endif %}>
                        üî• –¢–µ—Ä–º–æ—Ñ–∏–ª—ã
                    </option>
                    <option value="halophiles" {% if request.GET.extremophiles == "halophiles" %}selected{% endif %}>
                        üßÇ –ì–∞–ª–æ—Ñ–∏–ª—ã
                    </option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label">
                    <i class="bi bi-dna"></i> –° –≥–µ–Ω–æ–º–æ–º
                </label>
                <select class="form-select" name="has_genome">
                    <option value="">–í—Å–µ —à—Ç–∞–º–º—ã</option>
                    <option value="true" {% if request.GET.has_genome == "true" %}selected{% endif %}>
                        ‚úÖ –°–µ–∫–≤–µ–Ω–∏—Ä–æ–≤–∞–Ω—ã
                    </option>
                    <option value="false" {% if request.GET.has_genome == "false" %}selected{% endif %}>
                        ‚ùå –ù–µ —Å–µ–∫–≤–µ–Ω–∏—Ä–æ–≤–∞–Ω—ã
                    </option>
                </select>
            </div>
            
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-filter"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 strain-card">
                <div class="card-body text-center">
                    <i class="bi bi-snow fs-1 text-info mb-2"></i>
                    <h5>–ü—Å–∏—Ö—Ä–æ—Ñ–∏–ª—ã</h5>
                    <h3 class="text-primary">{{ psychrophiles_count }}</h3>
                    <small class="text-muted">—Ö–æ–ª–æ–¥–æ–ª—é–±–∏–≤—ã–µ</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 strain-card">
                <div class="card-body text-center">
                    <i class="bi bi-fire fs-1 text-danger mb-2"></i>
                    <h5>–¢–µ—Ä–º–æ—Ñ–∏–ª—ã</h5>
                    <h3 class="text-primary">{{ thermophiles_count }}</h3>
                    <small class="text-muted">—Ç–µ–ø–ª–æ–ª—é–±–∏–≤—ã–µ</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 strain-card">
                <div class="card-body text-center">
                    <i class="bi bi-droplet fs-1 text-warning mb-2"></i>
                    <h5>–ì–∞–ª–æ—Ñ–∏–ª—ã</h5>
                    <h3 class="text-primary">{{ halophiles_count }}</h3>
                    <small class="text-muted">—Å–æ–ª–µ–ª—é–±–∏–≤—ã–µ</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 strain-card">
                <div class="card-body text-center">
                    <i class="bi bi-cpu fs-1 text-success mb-2"></i>
                    <h5>–°–µ–∫–≤–µ–Ω–∏—Ä–æ–≤–∞–Ω—ã</h5>
                    <h3 class="text-primary">{{ sequenced_count }}</h3>
                    <small class="text-muted">—Å –≥–µ–Ω–æ–º–æ–º</small>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="data-table">
        <div class="table-header p-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0">
                        <i class="bi bi-table"></i>
                        –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —à—Ç–∞–º–º–∞–º
                    </h4>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-light btn-sm" onclick="exportData('csv')">
                            <i class="bi bi-file-spreadsheet"></i> CSV
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="exportData('fasta')">
                            <i class="bi bi-file-binary"></i> FASTA
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showMap()">
                            <i class="bi bi-map"></i> –ö–∞—Ä—Ç–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="strainsTable">
                <thead class="bg-light">
                    <tr>
                        <th style="width: 120px;">
                            <i class="bi bi-hash"></i> –®—Ç–∞–º–º
                        </th>
                        <th>
                            <i class="bi bi-diagram-3"></i> –ù–∞—É—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        </th>
                        <th style="width: 120px;">
                            <i class="bi bi-collection"></i> –ö–æ–ª–ª–µ–∫—Ü–∏—è
                        </th>
                        <th style="width: 100px;">
                            <i class="bi bi-thermometer"></i> –¢–µ–º–ø. ¬∞C
                        </th>
                        <th style="width: 80px;">
                            <i class="bi bi-ph"></i> pH
                        </th>
                        <th style="width: 120px;">
                            <i class="bi bi-geo-alt"></i> –õ–æ–∫–∞—Ü–∏—è
                        </th>
                        <th style="width: 100px;">
                            <i class="bi bi-award"></i> –°–≤–æ–π—Å—Ç–≤–∞
                        </th>
                        <th style="width: 80px;">
                            <i class="bi bi-dna"></i> –ì–µ–Ω–æ–º
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for strain in strains %}
                    <tr class="strain-row" data-strain-id="{{ strain.id }}">
                        <td>
                            <strong class="text-primary">{{ strain.full_name }}</strong>
                            <br>
                            <small class="text-muted">#{{ strain.strain_number }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="organism-icon">
                                    {% if strain.organism_type == 'bacteria' %}ü¶†{% elif strain.organism_type == 'archaea' %}üåø{% else %}üî¨{% endif %}
                                </span>
                                <div>
                                    <em class="fw-bold">{{ strain.scientific_name }}</em>
                                    <br>
                                    <small class="text-muted">{{ strain.genus }} {{ strain.species }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge" style="background: var(--baikal-accent);">
                                {{ strain.collection.code }}
                            </span>
                            <br>
                            <small class="text-muted">{{ strain.collection.get_collection_type_display }}</small>
                        </td>
                        <td>
                            <div class="characteristic-bar">
                                <div class="characteristic-fill temp-fill" 
                                     style="width: {% if strain.optimal_temperature %}{{ strain.optimal_temperature|floatformat:0 }}{% else %}0{% endif %}%"></div>
                            </div>
                            <small>{% if strain.optimal_temperature %}{{ strain.optimal_temperature }}¬∞C{% else %}‚Äî{% endif %}</small>
                            {% if strain.is_psychrophile %}
                                <br><span class="badge bg-info">‚ùÑÔ∏è</span>
                            {% endif %}
                            {% if strain.is_thermophile %}
                                <br><span class="badge bg-danger">üî•</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="characteristic-bar">
                                <div class="characteristic-fill ph-fill" 
                                     style="width: {% if strain.optimal_ph %}{% widthratio strain.optimal_ph 14 100 %}{% else %}50{% endif %}%"></div>
                            </div>
                            <small>{% if strain.optimal_ph %}{{ strain.optimal_ph }}{% else %}‚Äî{% endif %}</small>
                        </td>
                        <td>
                            {% if strain.latitude and strain.longitude %}
                                <a href="#" class="coordinates-link" 
                                   onclick="showStrainOnMap({{ strain.latitude }}, {{ strain.longitude }}, '{{ strain.full_name }}')">
                                    <i class="bi bi-geo-alt"></i>
                                    {{ strain.latitude|floatformat:3 }},<br>{{ strain.longitude|floatformat:3 }}
                                </a>
                                <br>
                                <small class="text-muted">{{ strain.get_habitat_type_display }}</small>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                {% if strain.produces_antibiotics %}
                                    <span class="badge extremophile-badge">üíä</span>
                                {% endif %}
                                {% if strain.produces_enzymes %}
                                    <span class="badge bg-success">üß™</span>
                                {% endif %}
                                {% if strain.nitrogen_fixation %}
                                    <span class="badge bg-warning">üå±</span>
                                {% endif %}
                                {% if strain.is_halophile %}
                                    <span class="badge bg-secondary">üßÇ</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if strain.has_genome_sequence %}
                                <div class="characteristic-bar">
                                    <div class="characteristic-fill genome-fill" style="width: 85%"></div>
                                </div>
                                <a href="#" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-dna"></i>
                                </a>
                                <br>
                                <small class="text-success">
                                    {% if strain.genome_size %}{{ strain.genome_size|filesizeformat }}{% else %}‚Äî{% endif %}
                                </small>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
                            <h5 class="text-muted">–®—Ç–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if is_paginated %}
        <div class="p-3 border-top">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{{ request.GET.urlencode }}">–ü–µ—Ä–≤–∞—è</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ request.GET.urlencode }}">‚Äπ</a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{{ request.GET.urlencode }}">‚Ä∫</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ request.GET.urlencode }}">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
function exportData(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    window.location.href = '{% url "catalog:strain_export" %}?' + params.toString();
}

function showMap() {
    const modal = new bootstrap.Modal(document.getElementById('mapModal'));
    modal.show();
    initBaikalMap();
}

function showStrainOnMap(lat, lon, name) {
    alert(`–ü–æ–∫–∞–∑–∞—Ç—å ${name} –Ω–∞ –∫–∞—Ä—Ç–µ –ë–∞–π–∫–∞–ª–∞:\n–®–∏—Ä–æ—Ç–∞: ${lat}\n–î–æ–ª–≥–æ—Ç–∞: ${lon}`);
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞—Ä—Ç–æ–π
}

// –ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const selects = filterForm.querySelectorAll('select');
    
    selects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –ø–æ–ª—è
    const searchInput = filterForm.querySelector('input[name="search"]');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterForm.submit();
        }, 500);
    });
});

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
function sortTable(column) {
    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ
    console.log('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–µ:', column);
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞—Ä—Ç—ã -->
<div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-map"></i> –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ë–∞–π–∫–∞–ª–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="height: 600px;">
                <div id="baikalMap" style="height: 100%; background: #E3F2FD; display: flex; align-items: center; justify-content: center;">
                    <div class="text-center">
                        <i class="bi bi-map fs-1 text-primary mb-3 d-block"></i>
                        <h5>–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞—Ü–∏–π —à—Ç–∞–º–º–æ–≤</h5>
                        <p class="text-muted">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏<br>–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 